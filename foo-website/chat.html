<!-- foo/chat.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>User Chat â€” Minicom (Foo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --blue:#0A84FF; --muted:#f1f3f7; }
    body { font-family: Arial, sans-serif; margin:0; background:#f7f9fb; height:100vh; }
    /* page content so background isn't blank */
    .hero { padding:40px; max-width:900px; margin:0 auto; color:#333; }
    .hero h1 { margin:0 0 6px }
    .hero p { color:#666 }
    /* floating bubble */
    #chat-bubble { position:fixed; right:20px; bottom:20px; background:var(--blue); width:62px; height:62px; border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center; font-size:26px; cursor:pointer; box-shadow:0 8px 20px rgba(10,132,255,0.18); z-index:9999 }
    /* chat window */
    #chat-window { position:fixed; right:20px; bottom:96px; width:340px; max-height:520px; background:white; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,0.18); display:none; flex-direction:column; overflow:hidden; z-index:9999 }
    #chat-header { background:var(--blue); color:white; padding:12px; font-weight:600; text-align:center }
    #messages { padding:14px; display:flex; flex-direction:column; gap:8px; overflow-y:auto; min-height:140px; max-height:420px; background:#f5f7fa }
    .msg { padding:10px 12px; border-radius:14px; max-width:75%; line-height:1.4; font-size:14px; word-break:break-word; }
    .msg-admin { background:#e9e9eb; color:#111; align-self:flex-start; border-bottom-left-radius:4px; }
    .msg-user { background:var(--blue); color:white; align-self:flex-end; border-bottom-right-radius:4px; }
    #input-area { display:flex; gap:8px; padding:10px; border-top:1px solid #eee; background:white; }
    #msg { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }
    #send-btn { background:var(--blue); color:white; padding:10px 12px; border:none; border-radius:8px; cursor:pointer }
  </style>
</head>
<body>

  <div class="hero">
    <h1>Welcome to Minicom demo</h1>
    <p>Use the chat bubble at bottom-right to open the support chat. Your session email will be used to identify you.</p>
  </div>

  <div id="chat-bubble">ðŸ’¬</div>

  <div id="chat-window">
    <div id="chat-header">Support</div>
    <div id="messages"><div id="empty" style="text-align:center;color:#777;padding:30px">No messages yet â€” say hi!</div></div>
    <div id="input-area">
      <input id="msg" placeholder="Type a message..." />
      <button id="send-btn">Send</button>
    </div>
  </div>

<script>
  // CONFIG: backend host (adjust if needed)
  const BACKEND_HOST = 'localhost:8000'; // change to your Django host:port

  // check login (sessionStorage)
  const email = sessionStorage.getItem('email');
  if (!email) {
    window.location = 'login.html';
  }

  // UI toggles
  const bubble = document.getElementById('chat-bubble');
  const windowBox = document.getElementById('chat-window');
  bubble.onclick = () => {
    windowBox.style.display = (windowBox.style.display === 'flex') ? 'none' : 'flex';
    if (windowBox.style.display === 'flex') {
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
      // Mark messages as read when opening the window
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: 'read_messages' }));
      }
    }
  };

  // WebSocket (user role)
  const socket = new WebSocket(`ws://${BACKEND_HOST}/ws/chat/user/${encodeURIComponent(email)}/`);

  socket.onopen = () => {
    console.info('WS open (user)');
  };

  socket.onmessage = (evt) => {
    const data = JSON.parse(evt.data);
    if (data.type === 'history' || data.type === 'conversation') {
      // remove empty if present
      const empty = document.getElementById('empty'); if (empty) empty.remove();
      data.messages.forEach(renderMessage);
    } else if (data.type === 'message') {
      const empty = document.getElementById('empty'); if (empty) empty.remove();
      renderMessage(data.message);
      
      // If window is open, mark as read immediately
      if (windowBox.style.display === 'flex') {
         socket.send(JSON.stringify({ type: 'read_messages' }));
      }
    } else if (data.type === 'messages_read') {
       // Update all my sent messages to double tick
       if (data.reader === 'admin') {
         document.querySelectorAll('.tick').forEach(el => el.textContent = 'âœ“âœ“');
       }
    }
  };

  socket.onclose = () => console.info('WS closed');

  function renderMessage(m) {
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.classList.add('msg', m.sender_type === 'admin' || m.sender_type === 'ai' ? 'msg-admin' : 'msg-user');
    
    // Add tick for user messages
    let tick = '';
    if (m.sender_type === 'user') {
        const status = m.is_read ? 'âœ“âœ“' : 'âœ“';
        tick = `<span class="tick" style="font-size:10px; margin-left:4px; color:#eee;">${status}</span>`;
    }
    
    div.innerHTML = m.content + tick;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  document.getElementById('send-btn').onclick = () => {
    const text = document.getElementById('msg').value.trim();
    if (!text) return;
    socket.send(JSON.stringify({ type: 'message', message: text }));
    document.getElementById('msg').value = '';
  };

  // optional: press Enter to send
  document.getElementById('msg').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); document.getElementById('send-btn').click(); }
  });
</script>
</body>
</html>
