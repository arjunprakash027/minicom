<!DOCTYPE html>
<html>
<body>

<h3>Chat with {{ email }}</h3>

<div id="messages"></div>

<input id="msg" placeholder="Reply..." />
<button onclick="sendMsg()">Send</button>

<script>
const admin = sessionStorage.getItem("email");
if (admin !== "admin@minicom.com") window.location = "/login/";

const email = "{{ email }}";
const socket = new WebSocket(`ws://${window.location.host}/ws/chat/admin/${email}/`);

// helpers - defensive field access
function getSender(m) {
    return m.sender_type ?? m.direction ?? m.sender ?? "unknown";
}
function getContent(m) {
    return m.content ?? m.message ?? m.text ?? "";
}

socket.onopen = () => {
    socket.send(JSON.stringify({type: "get_conversation", email}));
};

socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "conversation" || data.type === "history") {
        render(data.messages || []);
    } else if (data.type === "message") {
        // data.message is a single message object
        add(data.message);
    }
};

function render(msgs) {
    const box = document.getElementById("messages");
    box.innerHTML = (msgs || []).map(m =>
        `<p><b>${escapeHtml(getSender(m))}:</b> ${escapeHtml(getContent(m))}</p>`
    ).join("");
    scrollBottom();
}

function add(m) {
    const box = document.getElementById("messages");
    box.innerHTML += `<p><b>${escapeHtml(getSender(m))}:</b> ${escapeHtml(getContent(m))}</p>`;
    scrollBottom();
}

function sendMsg() {
    const text = document.getElementById("msg").value.trim();
    if (!text) return;
    socket.send(JSON.stringify({type:"message", to: email, message:text}));
    document.getElementById("msg").value = "";
}

// small utility to avoid XSS when rendering strings
function escapeHtml(str) {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function scrollBottom() {
    const box = document.getElementById("messages");
    box.scrollTop = box.scrollHeight;
}
</script>

</body>
</html>
