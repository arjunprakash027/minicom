<!DOCTYPE html>
<html>
<body>

<h2>Chat with {{ email }}</h2>

<!-- If not admin, redirect -->
<script>
if (sessionStorage.getItem("userEmail") !== "admin@minicom.com") {
    window.location = "/login/";
}
</script>

<div id="messages"></div>

<input id="msg" placeholder="Reply...">
<button onclick="sendMsg()">Send</button>

<script>
const email = "{{ email }}";

function loadMessages() {
    fetch(`/api/messages/${email}/`)
        .then(response => response.json())
        .then(data => {
            const box = document.getElementById("messages");
            box.innerHTML = data
                .map(m => `<p><b>${m.sender_type}:</b> ${m.content}</p>`)
                .join("");
        });
}

function sendMsg() {
    const content = document.getElementById("msg").value;

    fetch(`/api/send/admin@minicom.com/${email}/`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({content})
    })
    .then(() => {
        document.getElementById("msg").value = "";
        loadMessages();
    });
}

setInterval(loadMessages, 1500);
loadMessages();
</script>

</body>
</html>
