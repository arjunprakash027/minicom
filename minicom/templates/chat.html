<!DOCTYPE html>
<html>
<body>
<h3>Your Chat</h3>

<div id="messages" style="max-height:60vh; overflow:auto"></div>

<input id="msg" placeholder="Type..." />
<button onclick="sendMsg()">Send</button>

<script>
const email = sessionStorage.getItem("email");
if (!email) window.location = "/login/";

const socket = new WebSocket(`ws://${window.location.host}/ws/chat/user/${email}/`);

// helpers - defensive field access
function getSender(m) {
    return m.sender_type ?? m.direction ?? m.sender ?? "unknown";
}
function getContent(m) {
    return m.content ?? m.message ?? m.text ?? "";
}

socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "history" || data.type === "conversation") {
        render(data.messages || []);
    } else if (data.type === "message") {
        add(data.message);
    }
};

function render(msgs) {
    const box = document.getElementById("messages");
    box.innerHTML = (msgs || []).map(m =>
        `<p><b>${escapeHtml(getSender(m))}:</b> ${escapeHtml(getContent(m))}</p>`
    ).join("");
    scrollBottom();
}

function add(m) {
    const box = document.getElementById("messages");
    box.innerHTML += `<p><b>${escapeHtml(getSender(m))}:</b> ${escapeHtml(getContent(m))}</p>`;
    scrollBottom();
}

function sendMsg() {
    const text = document.getElementById("msg").value.trim();
    if (!text) return;
    socket.send(JSON.stringify({type: "message", message: text}));
    document.getElementById("msg").value = "";
}

// escape helper
function escapeHtml(str) {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function scrollBottom() {
    const box = document.getElementById("messages");
    box.scrollTop = box.scrollHeight;
}
</script>

</body>
</html>
